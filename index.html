<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inspiration Gallery</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background:#fff; color:#1D1D1D; font-family:'Inter',sans-serif; min-height:100vh; }

  .topbar { background:#fff; padding:18px 24px 0; position:sticky; top:0; z-index:100; border-bottom:1px solid #ebebeb; }
  .site-title { text-align:center; font-size:13px; font-weight:500; color:#1D1D1D; letter-spacing:.01em; padding-bottom:14px; }
  .topbar-row { display:flex; align-items:center; justify-content:space-between; gap:16px; padding-bottom:12px; }
  .search-wrap { position:relative; }
  .search-input { width:240px; background:#fff; border:1px solid #ebebeb; border-radius:8px; padding:8px 12px 8px 36px;
    font-family:'Inter',sans-serif; font-size:13px; color:#111; outline:none; transition:border-color .15s; }
  .search-input::placeholder { color:#aaa; }
  .search-input:focus { border-color:#bbb; }
  .search-icon { position:absolute; left:11px; top:50%; transform:translateY(-50%); color:#aaa; pointer-events:none; }

  .topbar-right { display:flex; align-items:center; gap:8px; }
  .site-count { font-size:13px; color:#9F9FA0; font-weight:400; }

  .add-btn { display:flex; align-items:center; gap:6px; background:#c8f135; color:#111; border:none; border-radius:8px;
    padding:8px 16px; font-family:'Inter',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:background .15s; }
  .add-btn:hover { background:#b8e020; }

  .add-cat-btn { display:flex; align-items:center; gap:6px; background:transparent; color:#1D1D1D; border:1px solid #ebebeb;
    border-radius:8px; padding:8px 16px; font-family:'Inter',sans-serif; font-size:13px; font-weight:500; cursor:pointer;
    transition:all .15s; white-space:nowrap; }
  .add-cat-btn:hover { border-color:#ccc; background:#f9f9f9; }

  .filter-wrap { position:relative; padding-bottom:8px; }
  .filter-row { display:flex; gap:6px; flex-wrap:wrap; overflow:hidden; height:32px; transition:height .3s cubic-bezier(.4,0,.2,1);
    padding-right:36px; }
  .filter-row.expanded { height:auto; }
  .filter-toggle { position:absolute; right:0; top:0; width:28px; height:28px; background:#fff; border:1px solid #ebebeb;
    border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#9F9FA0;
    transition:background .15s, color .15s, border-color .15s; flex-shrink:0; }
  .filter-toggle:hover { background:#f5f5f7; color:#1D1D1D; border-color:#ccc; }
  .filter-toggle svg { transition:transform .3s cubic-bezier(.4,0,.2,1); }
  .filter-toggle.open svg { transform:rotate(180deg); }

  .filter-btn { background:transparent; border:1px solid #ebebeb; color:#9F9FA0; padding:5px 8px; border-radius:8px;
    font-family:'Inter',sans-serif; font-size:13px; font-weight:500; cursor:pointer; transition:all .15s; }
  .filter-btn:hover { border-color:#ccc; color:#1D1D1D; }
  .filter-btn.active { background:#111; border-color:#111; color:#fff; }
  .filter-btn.dragging { opacity:.4; cursor:grabbing; }
  .filter-btn.drag-over { border-color:#c8f135; background:#f9ffe8; }
  .filter-btn[draggable="true"] { cursor:grab; }
  .filter-btn[draggable="true"]:active { cursor:grabbing; }

  main { padding:24px 24px 60px; }
  .category-section { margin-bottom:32px; }
  .category-header { display:flex; align-items:baseline; gap:10px; margin-bottom:12px; }
  .category-name { font-size:26px; font-weight:800; color:#1D1D1D; letter-spacing:-.5px; }
  .category-count { font-size:13px; color:#9F9FA0; font-weight:400; }
  .category-header-right { margin-left:auto; display:flex; align-items:center; gap:4px; }
  .sort-btn { background:transparent; border:none; font-family:'Inter',sans-serif; font-size:12px; color:#9F9FA0; cursor:pointer;
    padding:3px 8px; border-radius:6px; transition:all .15s; font-weight:400; }
  .sort-btn:hover { color:#1D1D1D; background:#f5f5f7; }
  .sort-btn.active { color:#1D1D1D; font-weight:600; background:#f0f0f2; }

  .cards-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  @media (max-width:1100px){ .cards-grid{ grid-template-columns:repeat(3,1fr);} }
  @media (max-width:780px){ .cards-grid{ grid-template-columns:repeat(2,1fr);} }
  @media (max-width:480px){ .cards-grid{ grid-template-columns:1fr;} }

  .card { background:#F5F5F7; border-radius:8px; overflow:hidden; text-decoration:none; color:inherit; display:block;
    position:relative; transition:transform .2s ease, box-shadow .2s ease; }
  .card:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(0,0,0,.1); }

  .card-preview { width:100%; aspect-ratio:16/10; background:#ebebeb; overflow:hidden; position:relative; }
  .card-preview img { width:100%; height:100%; object-fit:cover; display:block; transition:transform .4s ease; }
  .card:hover .card-preview img { transform:scale(1.03); }

  .preview-favicon-wrap { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:10px; background:#F5F5F7; }
  .preview-favicon { width:40px; height:40px; border-radius:10px; object-fit:contain; }
  .preview-favicon-domain { font-size:11px; color:#9F9FA0; font-family:'Inter',sans-serif; text-align:center; padding:0 10px; }

  .card-info { padding:12px 14px 14px; }
  .card-name { font-size:14px; font-weight:600; color:#1D1D1D; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .card-domain { font-size:12px; color:#9F9FA0; }
  .card-note { color:#c8a96e; font-style:italic; }

  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); backdrop-filter:blur(4px);
    z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:#fff; border-radius:8px; padding:32px; width:100%; max-width:440px; box-shadow:0 24px 64px rgba(0,0,0,.15); }
  .modal h2 { font-size:18px; font-weight:700; margin-bottom:4px; }
  .modal > p { font-size:13px; color:#888; margin-bottom:24px; }
  .modal-field { display:flex; flex-direction:column; gap:5px; margin-bottom:14px; }
  .modal-field label { font-size:11px; font-weight:600; color:#888; letter-spacing:.08em; text-transform:uppercase; }
  .modal-field input, .modal-field select {
    background:#f7f7f7; border:1px solid #ebebeb; border-radius:8px; color:#1D1D1D; padding:9px 12px;
    font-family:'Inter',sans-serif; font-size:13px; outline:none; transition:border-color .15s, background .15s; width:100%;
  }
  .modal-field input:focus, .modal-field select:focus { border-color:#aaa; background:#fff; }
  .modal-actions { display:flex; gap:8px; margin-top:20px; }
  .btn-primary { flex:1; background:#c8f135; color:#111; border:none; border-radius:8px; padding:10px;
    font-family:'Inter',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:background .15s; }
  .btn-primary:hover { background:#b8e020; }
  .btn-ghost { background:transparent; color:#888; border:1px solid #ebebeb; border-radius:8px; padding:10px 18px;
    font-family:'Inter',sans-serif; font-size:13px; cursor:pointer; transition:all .15s; }
  .btn-ghost:hover { color:#111; border-color:#bbb; }

  .empty { text-align:center; padding:80px 0; color:#bbb; font-size:13px; }

  .app-loading { position:fixed; inset:0; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:16px; z-index:999; transition:opacity .3s; }
  .app-loading.hidden { opacity:0; pointer-events:none; }
  .app-loading-spinner { width:28px; height:28px; border:2px solid #ebebeb; border-top-color:#1D1D1D; border-radius:50%;
    animation:spin .7s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .app-loading p { font-size:13px; color:#9F9FA0; font-family:'Inter',sans-serif; }

  .setup-banner { background:#fffbe6; border:1px solid #f5e06e; border-radius:8px; padding:12px 16px; margin:16px 24px 0;
    font-size:13px; color:#7a6500; display:flex; align-items:center; gap:10px; }
  .setup-banner a { color:#7a6500; font-weight:600; }
  .setup-banner.hidden { display:none; }

  .card-delete, .card-edit {
    position:absolute; top:8px; background:rgba(255,255,255,.92); border:1px solid #ebebeb; color:#9F9FA0;
    border-radius:7px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer;
    opacity:0; transform:scale(.85); transition:opacity .15s, transform .15s, color .15s, background .15s; z-index:10;
  }
  .card-delete { right:8px; }
  .card-edit { right:46px; }
  .card:hover .card-delete, .card:hover .card-edit { opacity:1; transform:scale(1); }
  .card-delete:hover { background:#fff0f0; color:#e05555; border-color:#f5c5c5; }
  .card-edit:hover { background:#f0f8ff; color:#4a90d9; border-color:#c5dff5; }

  /* ✅ Categories modal scroll */
  #catModal .modal{
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #catList{
    overflow-y: auto;
    max-height: 50vh;
    padding-right: 6px;
  }
</style>
</head>

<body>
<div class="app-loading" id="appLoading">
  <div class="app-loading-spinner"></div>
  <p>Loading your gallery...</p>
</div>

<div class="setup-banner hidden" id="setupBanner">
  ⚠️ Supabase not configured — changes won't be saved.
  <a href="#" onclick="showSetupHelp()">How to set up →</a>
</div>

<div class="topbar">
  <div class="site-title">blazek.design inspo</div>

  <div class="topbar-row">
    <div class="search-wrap">
      <svg class="search-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
      </svg>
      <input type="text" class="search-input" placeholder="Search sites ..." id="searchInput" oninput="renderAll()">
    </div>

    <div class="topbar-right">
      <span class="site-count" id="siteCount">0 sites</span>

      <button class="add-cat-btn" onclick="openCatModal()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
        Categories
      </button>

      <button class="add-btn" onclick="openModal()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Add site
      </button>
    </div>
  </div>

  <div class="filter-wrap">
    <div class="filter-row" id="filterBar"></div>
    <button class="filter-toggle" id="filterToggle" onclick="toggleFilters()" title="Show all categories">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </button>
  </div>
</div>

<main id="main"></main>

<!-- ADD MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>Add a site</h2>
    <p>Paste a URL, give it a name, and pick a category.</p>

    <div class="modal-field">
      <label>URL</label>
      <input type="url" id="newUrl" placeholder="https://example.com" />
    </div>
    <div class="modal-field">
      <label>Name (optional)</label>
      <input type="text" id="newName" placeholder="e.g. Stripe" />
    </div>
    <div class="modal-field">
      <label>Note (optional)</label>
      <input type="text" id="newNote" placeholder="e.g. Old money vibes" />
    </div>
    <div class="modal-field">
      <label>Category</label>
      <select id="newCat"></select>
    </div>
    <div class="modal-field">
      <label>Or create new category</label>
      <input type="text" id="newCatName" placeholder="e.g. E-commerce" />
    </div>

    <div class="modal-actions">
      <button class="btn-primary" onclick="addSite()">Add site</button>
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- CATEGORY MODAL -->
<div class="modal-overlay" id="catModal">
  <div class="modal">
    <h2>Categories</h2>
    <p>Add or delete categories. (Rename is supported too.)</p>

    <div class="modal-field">
      <label>New category</label>
      <input type="text" id="catModalName" placeholder="New category name..." onkeydown="if(event.key==='Enter') addCategory()" />
    </div>

    <div class="modal-actions">
      <button class="btn-primary" onclick="addCategory()">Add</button>
      <button class="btn-ghost" onclick="closeCatModal()">Close</button>
    </div>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:8px;" id="catList"></div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>Edit site</h2>
    <p>Update the details for this site.</p>

    <div class="modal-field">
      <label>URL</label>
      <input type="url" id="editUrl" placeholder="https://example.com" />
    </div>
    <div class="modal-field">
      <label>Name</label>
      <input type="text" id="editName" placeholder="e.g. Stripe" />
    </div>
    <div class="modal-field">
      <label>Note (optional)</label>
      <input type="text" id="editNote" placeholder="e.g. Old money vibes" />
    </div>
    <div class="modal-field">
      <label>Category</label>
      <select id="editCat"></select>
    </div>

    <div class="modal-actions">
      <button class="btn-primary" onclick="saveEdit()">Save changes</button>
      <button class="btn-ghost" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/** =========================
 *  1) CONFIG — PASTE HERE
 *  ========================= */
const SUPABASE_URL = 'https://avzofgqilxoxmfukwrpc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2em9mZ3FpbHhveG1mdWt3cnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDU0MDQsImV4cCI6MjA4NzY4MTQwNH0.e5LhEwg-o7--VFAwzKFOqdAYtTWCnifBsd9lxaasFms';

/** =========================
 *  2) OPTIONAL FALLBACK DATA
 *  ========================= */
const INITIAL_DATA = [
  { url: 'https://example.com', name: 'example.com', category: 'Inspo' },
];

/** =========================
 *  3) SUPABASE INIT (CDN)
 *  ========================= */
let supabaseClient = null;
let isSupabaseReady = false;

try {
  if (SUPABASE_URL && SUPABASE_ANON_KEY &&
      !SUPABASE_URL.includes('PASTE_YOUR') && !SUPABASE_ANON_KEY.includes('PASTE_YOUR')) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    isSupabaseReady = true;
  }
} catch (e) {
  console.warn('Supabase init failed:', e);
}

/** =========================
 *  4) APP STATE
 *  ========================= */
let sites = [];
let activeFilter = 'all';
let catOrder = null;
const catSort = {};
let editingId = null;

// small cache so we don't refetch previews constantly while you scroll/search
const previewCache = new Map();

function getDomain(url) {
  try { return new URL(url).hostname.replace('www.', ''); }
  catch { return url; }
}

function getCategories() {
  const fromSites = [...new Set(sites.map(s => s.category))];
  const empty = (window._emptyCategories || []).filter(c => !fromSites.includes(c));
  return [...fromSites, ...empty];
}

/** =========================
 *  4.5) OG PREVIEW (Microlink)
 *  ========================= */
function microlinkApi(url) {
  return `https://api.microlink.io/?url=${encodeURIComponent(url)}&meta=true`;
}

async function fetchPreview(url) {
  if (!url) return { title: null, description: null, image: null };
  if (previewCache.has(url)) return previewCache.get(url);

  const fallback = { title: null, description: null, image: null };
  try {
    const res = await fetch(microlinkApi(url));
    const json = await res.json();
    const data = json?.data;

    const out = {
      title: data?.title || null,
      description: data?.description || null,
      image: (data?.image && (data.image.url || data.image)) || null,
    };
    previewCache.set(url, out);
    return out;
  } catch (e) {
    previewCache.set(url, fallback);
    return fallback;
  }
}

/** =========================
 *  5) UI — FILTERS
 *  ========================= */
function updateFilterHeight() {
  const bar = document.getElementById('filterBar');
  const toggle = document.getElementById('filterToggle');
  if (!bar || !toggle) return;
  if (bar.classList.contains('expanded')) bar.style.height = bar.scrollHeight + 'px';
  else bar.style.height = '32px';
  const hasOverflow = bar.scrollHeight > 40;
  toggle.style.display = hasOverflow ? 'flex' : 'none';
}

function toggleFilters() {
  const bar = document.getElementById('filterBar');
  const toggle = document.getElementById('filterToggle');
  const isExpanded = bar.classList.contains('expanded');
  if (isExpanded) {
    bar.style.height = bar.scrollHeight + 'px';
    requestAnimationFrame(() => {
      bar.style.height = '32px';
      bar.classList.remove('expanded');
      toggle.classList.remove('open');
    });
  } else {
    bar.classList.add('expanded');
    bar.style.height = bar.scrollHeight + 'px';
    toggle.classList.add('open');
    bar.addEventListener('transitionend', () => {
      if (bar.classList.contains('expanded')) bar.style.height = 'auto';
    }, { once:true });
  }
}

function setFilter(cat, btn) {
  activeFilter = cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

function buildFilters() {
  const bar = document.getElementById('filterBar');
  bar.innerHTML = '';

  const cats = catOrder
    ? catOrder.filter(c => getCategories().includes(c)).concat(getCategories().filter(c => !catOrder.includes(c)))
    : getCategories();

  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn' + (activeFilter === 'all' ? ' active' : '');
  allBtn.textContent = 'All';
  allBtn.onclick = () => setFilter('all', allBtn);
  bar.appendChild(allBtn);

  cats.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (activeFilter === cat ? ' active' : '');
    btn.textContent = cat;
    btn.draggable = true;
    btn.dataset.cat = cat;
    btn.onclick = () => setFilter(cat, btn);

    btn.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', cat);
      btn.classList.add('dragging');
      setTimeout(() => btn.classList.add('dragging'), 0);
    });
    btn.addEventListener('dragend', () => btn.classList.remove('dragging'));
    btn.addEventListener('dragover', e => { e.preventDefault(); btn.classList.add('drag-over'); });
    btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
    btn.addEventListener('drop', async e => {
      e.preventDefault();
      btn.classList.remove('drag-over');
      const fromCat = e.dataTransfer.getData('text/plain');
      if (fromCat === cat) return;

      const currentOrder = catOrder || getCategories();
      const newOrder = [...currentOrder];
      const fromIdx = newOrder.indexOf(fromCat);
      const toIdx = newOrder.indexOf(cat);
      if (fromIdx !== -1 && toIdx !== -1) {
        newOrder.splice(fromIdx, 1);
        newOrder.splice(toIdx, 0, fromCat);
        catOrder = newOrder;
        buildFilters();
        await saveCatOrder();
      }
    });

    bar.appendChild(btn);
  });

  updateFilterHeight();
}

/** =========================
 *  6) UI — MODALS
 *  ========================= */
function openModal() {
  closeCatModal();
  const sel = document.getElementById('newCat');
  sel.innerHTML = getCategories().map(c => `<option value="${c}">${c}</option>`).join('');
  document.getElementById('modal').classList.add('open');
  setTimeout(() => document.getElementById('newUrl').focus(), 50);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  ['newUrl','newName','newNote','newCatName'].forEach(id => document.getElementById(id).value = '');
}

function openCatModal() {
  closeModal();
  renderCatList();
  document.getElementById('catModal').classList.add('open');
  setTimeout(() => document.getElementById('catModalName').focus(), 50);
}
function closeCatModal() {
  document.getElementById('catModal').classList.remove('open');
  document.getElementById('catModalName').value = '';
}

function renderCatList() {
  const list = document.getElementById('catList');
  const cats = getCategories();
  list.innerHTML = '';
  cats.forEach(cat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.gap = '8px';
    row.style.alignItems = 'center';
    row.style.border = '1px solid #ebebeb';
    row.style.borderRadius = '8px';
    row.style.padding = '8px 10px';

    const left = document.createElement('div');
    left.style.minWidth = '0';
    left.style.flex = '1';
    left.innerHTML = `<div style="font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${cat}</div>
                      <div style="font-size:12px; color:#9F9FA0;">${sites.filter(s=>s.category===cat).length} sites</div>`;

    const actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.gap = '6px';

    const renameBtn = document.createElement('button');
    renameBtn.className = 'btn-ghost';
    renameBtn.style.padding = '6px 10px';
    renameBtn.textContent = 'Rename';
    renameBtn.onclick = async () => {
      const next = prompt('New name:', cat);
      if (!next || !next.trim() || next.trim() === cat) return;
      await renameCategory(cat, next.trim());
    };

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-ghost';
    delBtn.style.padding = '6px 10px';
    delBtn.textContent = 'Delete';
    delBtn.onclick = async () => {
      if (!confirm(`Delete category "${cat}" and all its sites?`)) return;
      await deleteCategory(cat);
    };

    actions.appendChild(renameBtn);
    actions.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(actions);
    list.appendChild(row);
  });
}

/** =========================
 *  7) CRUD — CATEGORIES
 *  ========================= */
async function saveCatOrder() {
  if (!isSupabaseReady) return;
  const order = catOrder || getCategories();

  const { data: existing } = await supabaseClient.from('category_order')
    .select('id').order('id', { ascending:true }).limit(1).maybeSingle();

  if (existing?.id) {
    const { error } = await supabaseClient.from('category_order').update({ cat_order: order }).eq('id', existing.id);
    if (error) console.error('saveCatOrder update error:', error);
  } else {
    const { error } = await supabaseClient.from('category_order').insert({ cat_order: order });
    if (error) console.error('saveCatOrder insert error:', error);
  }
}

async function addCategory() {
  const name = document.getElementById('catModalName').value.trim();
  if (!name) return;

  if (!getCategories().includes(name)) {
    window._emptyCategories = window._emptyCategories || [];
    window._emptyCategories.push(name);
  }

  document.getElementById('catModalName').value = '';
  await saveCatOrder();
  renderCatList();
  buildFilters();
  renderAll();
}

async function renameCategory(oldCat, newCat) {
  if (isSupabaseReady) {
    const { error } = await supabaseClient.from('sites').update({ category: newCat }).eq('category', oldCat);
    if (error) console.error('renameCategory error:', error);
  }

  sites.forEach(s => { if (s.category === oldCat) s.category = newCat; });
  if (window._emptyCategories) window._emptyCategories = window._emptyCategories.map(c => c === oldCat ? newCat : c);
  if (catOrder) catOrder = catOrder.map(c => c === oldCat ? newCat : c);
  if (activeFilter === oldCat) activeFilter = newCat;

  await saveCatOrder();
  renderCatList();
  buildFilters();
  renderAll();
}

async function deleteCategory(cat) {
  if (isSupabaseReady) {
    const { error } = await supabaseClient.from('sites').delete().eq('category', cat);
    if (error) console.error('deleteCategory error:', error);
  }

  sites = sites.filter(s => s.category !== cat);
  if (window._emptyCategories) window._emptyCategories = window._emptyCategories.filter(c => c !== cat);
  if (catOrder) catOrder = catOrder.filter(c => c !== cat);
  if (activeFilter === cat) activeFilter = 'all';

  await saveCatOrder();
  renderCatList();
  buildFilters();
  renderAll();
}

/** =========================
 *  8) CRUD — SITES
 *  ========================= */
async function addSite() {
  const url = document.getElementById('newUrl').value.trim();
  if (!url) return;

  const newCatName = document.getElementById('newCatName').value.trim();
  const cat = newCatName || document.getElementById('newCat').value || 'Uncategorized';
  const name = document.getElementById('newName').value.trim() || getDomain(url);
  const note = document.getElementById('newNote').value.trim() || null;

  const entry = { url, name, category: cat, note: note || undefined };

  if (isSupabaseReady) {
    const { data, error } = await supabaseClient
      .from('sites')
      .insert({ url, name, category: cat, note, custom_image: null })
      .select()
      .single();

    if (error) console.error('insert error:', error);
    if (data?.id) entry.id = data.id;
  }

  sites.push(entry);

  closeModal();
  buildFilters();
  renderAll();
  await saveCatOrder();
}

function openEditModal(site) {
  editingId = site.id ?? null;

  document.getElementById('editUrl').value = site.url;
  document.getElementById('editName').value = site.name;
  document.getElementById('editNote').value = site.note || '';
  const sel = document.getElementById('editCat');
  sel.innerHTML = getCategories().map(c => `<option value="${c}" ${c===site.category?'selected':''}>${c}</option>`).join('');

  document.getElementById('editModal').classList.add('open');
  setTimeout(() => document.getElementById('editName').focus(), 50);
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  editingId = null;
}

async function saveEdit() {
  const url = document.getElementById('editUrl').value.trim();
  if (!url) return;

  const name = document.getElementById('editName').value.trim() || getDomain(url);
  const note = document.getElementById('editNote').value.trim() || null;
  const category = document.getElementById('editCat').value;

  let idx = -1;
  if (editingId != null) idx = sites.findIndex(s => s.id === editingId);
  if (idx === -1) idx = sites.findIndex(s => s.url === url);
  if (idx === -1) return;

  sites[idx].url = url;
  sites[idx].name = name;
  sites[idx].note = note || undefined;
  sites[idx].category = category;

  if (isSupabaseReady && sites[idx].id != null) {
    const { error } = await supabaseClient.from('sites').update({ url, name, note, category }).eq('id', sites[idx].id);
    if (error) console.error('update error:', error);
  }

  closeEditModal();
  buildFilters();
  renderAll();
  await saveCatOrder();
}

async function deleteSite(site) {
  if (isSupabaseReady && site.id != null) {
    const { error } = await supabaseClient.from('sites').delete().eq('id', site.id);
    if (error) console.error('delete error:', error);
  }
  sites = sites.filter(s => s !== site);
  buildFilters();
  renderAll();
  await saveCatOrder();
}

/** =========================
 *  9) RENDER
 *  ========================= */
function getSorted(items, cat) {
  const mode = catSort[cat] || 'added';
  if (mode === 'alpha') return [...items].sort((a,b) => (a.name||'').localeCompare(b.name||''));
  return items;
}

function toggleSort(cat, mode, el) {
  catSort[cat] = mode;
  document.querySelectorAll(`.sort-btn[data-cat="${CSS.escape(cat)}"]`).forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });

  const grid = el.closest('.category-section').querySelector('.cards-grid');
  const query = document.getElementById('searchInput').value.toLowerCase();
  const base = sites.filter(s => s.category === cat);
  const filtered = query ? base.filter(s => (s.name||'').toLowerCase().includes(query) || getDomain(s.url).includes(query)) : base;

  grid.innerHTML = '';
  getSorted(filtered, cat).forEach(site => grid.appendChild(buildCard(site)));
}

function buildCard(site) {
  const card = document.createElement('a');
  card.className = 'card';
  card.href = site.url;
  card.target = '_blank';
  card.rel = 'noopener noreferrer';

  card.innerHTML = `
    <button class="card-edit" title="Edit site">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    </button>
    <button class="card-delete" title="Delete site">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/>
      </svg>
    </button>

    <div class="card-preview" data-url="${site.url}">
      <div class="preview-favicon-wrap">
        <img src="https://www.google.com/s2/favicons?domain=${getDomain(site.url)}&sz=64"
          class="preview-favicon" alt="${site.name}"
          onerror="this.style.display='none'"/>
        <span class="preview-favicon-domain">${getDomain(site.url)}</span>
      </div>
    </div>

    <div class="card-info">
      <div class="card-name">${site.name}</div>
      <div class="card-domain">
        ${getDomain(site.url)}
        ${site.note ? ' · <span class="card-note">' + site.note + '</span>' : ''}
      </div>
    </div>
  `;

  // ✅ Replace favicon view with OG preview image (if available)
  (async () => {
    const preview = await fetchPreview(site.url);
    if (preview?.image) {
      const previewEl = card.querySelector('.card-preview');
      // only replace if still same URL (avoids weirdness during re-render)
      if (previewEl && previewEl.dataset.url === site.url) {
        previewEl.innerHTML = `<img src="${preview.image}" alt="${site.name}">`;
      }
    }
  })();

  card.querySelector('.card-edit').addEventListener('click', e => {
    e.preventDefault(); e.stopPropagation();
    openEditModal(site);
  });

  card.querySelector('.card-delete').addEventListener('click', async e => {
    e.preventDefault(); e.stopPropagation();
    if (!confirm('Delete this site?')) return;
    await deleteSite(site);
  });

  return card;
}

function renderAll() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const main = document.getElementById('main');
  main.innerHTML = '';

  let totalShown = 0;

  getCategories().forEach(cat => {
    if (activeFilter !== 'all' && activeFilter !== cat) return;

    let filtered = sites.filter(s => s.category === cat);
    if (query) filtered = filtered.filter(s =>
      (s.name||'').toLowerCase().includes(query) || getDomain(s.url).includes(query)
    );
    if (!filtered.length) return;

    totalShown += filtered.length;
    const sortedFiltered = getSorted(filtered, cat);
    const curSort = catSort[cat] || 'added';

    const section = document.createElement('section');
    section.className = 'category-section';
    section.innerHTML = `
      <div class="category-header">
        <h2 class="category-name">${cat}</h2>
        <span class="category-count">${filtered.length} site${filtered.length !== 1 ? 's' : ''}</span>
        <div class="category-header-right">
          <button class="sort-btn ${curSort==='added'?'active':''}" data-cat="${cat}" data-mode="added"
            onclick="toggleSort('${cat.replace(/'/g,"\\'")}','added',this)">Last added</button>
          <button class="sort-btn ${curSort==='alpha'?'active':''}" data-cat="${cat}" data-mode="alpha"
            onclick="toggleSort('${cat.replace(/'/g,"\\'")}','alpha',this)">A–Z</button>
        </div>
      </div>
      <div class="cards-grid"></div>
    `;
    main.appendChild(section);

    const grid = section.querySelector('.cards-grid');
    sortedFiltered.forEach(site => grid.appendChild(buildCard(site)));
  });

  if (!totalShown) main.innerHTML = '<div class="empty">No sites found</div>';
  document.getElementById('siteCount').textContent = `${sites.length} site${sites.length !== 1 ? 's' : ''}`;
}

/** =========================
 *  10) INIT
 *  ========================= */
function hideLoading() {
  const el = document.getElementById('appLoading');
  el.classList.add('hidden');
  setTimeout(() => el.style.display = 'none', 350);
}

function showSetupHelp() {
  alert(
    'Supabase setup:\\n\\n' +
    '1) Create project in Supabase\\n' +
    '2) Run the SQL from this chat (tables + RLS policies)\\n' +
    '3) Settings → API: copy Project URL + anon key\\n' +
    '4) Paste them into SUPABASE_URL and SUPABASE_ANON_KEY in index.html\\n'
  );
}

async function initApp() {
  if (!isSupabaseReady) {
    console.warn('Supabase not configured — using local data only');
    document.getElementById('setupBanner').classList.remove('hidden');
    sites = [...INITIAL_DATA];
    hideLoading();
    buildFilters();
    renderAll();
    return;
  }

  try {
    const { data: orderData, error: orderErr } = await supabaseClient
      .from('category_order')
      .select('cat_order')
      .order('id', { ascending: true })
      .limit(1)
      .maybeSingle();

    if (orderErr) console.warn('category_order load warning:', orderErr);
    if (orderData?.cat_order) catOrder = orderData.cat_order;

    const { data, error } = await supabaseClient
      .from('sites')
      .select('*')
      .order('created_at', { ascending: true });

    if (error) throw error;

    sites = (data || []).map(row => ({
      id: row.id,
      url: row.url,
      name: row.name,
      category: row.category,
      note: row.note || undefined,
    }));
  } catch (e) {
    console.error('Failed to load from Supabase:', e);
    sites = [...INITIAL_DATA];
  }

  hideLoading();
  buildFilters();
  renderAll();
}

window.addEventListener('resize', updateFilterHeight);

document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
document.getElementById('catModal').addEventListener('click', e => { if (e.target.id === 'catModal') closeCatModal(); });
document.getElementById('editModal').addEventListener('click', e => { if (e.target.id === 'editModal') closeEditModal(); });

initApp();
</script>
</body>
</html>
